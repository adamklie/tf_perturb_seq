# CRISPR Pipeline Workflow

This document describes how to run the IGVF CRISPR Pipeline on TF Perturb-seq datasets.

## Overview

The pipeline processes single-cell CRISPR screening data through three main steps:

1. **Generate sample metadata** - Query IGVF portal for dataset information
2. **Upload to GCP** - Transfer files from IGVF/S3 to Google Cloud Storage
3. **Run CRISPR pipeline** - Execute the Nextflow pipeline on GCP

## Prerequisites

### Software Requirements

- Python 3.8+ with `requests` library
- [Google Cloud SDK](https://cloud.google.com/sdk/docs/install) (`gcloud`, `gsutil`)
- [Nextflow](https://www.nextflow.io/) 23.04+
- Java 17+
- Access to the `igvf-pertub-seq-pipeline` GCP project

### Environment Setup

```bash
# Install Python dependencies (if using uv)
cd /path/to/tf_perturb_seq
uv sync

# Or with pip
pip install requests

# Authenticate with GCP
gcloud auth login
gcloud config set project igvf-pertub-seq-pipeline

# Set IGVF API credentials
export IGVF_API_KEY="your-key"
export IGVF_SECRET_KEY="your-secret"
```

## Dataset Structure

Each dataset should follow this structure:

```
datasets/<DATASET_NAME>/
├── bin/
│   └── 1_CRISPR_pipeline/
│       ├── 1_generate_per_sample_metadata.sh
│       ├── 2_upload_to_gcp.sh
│       ├── 3_run_CRISPR_pipeline.sh
│       └── seqspec/
│           └── yaml_files/
│               ├── rna_seqspec.yml
│               ├── guide_seqspec.yml
│               └── hash_seqspec.yml   # if using cell hashing
├── nextflow.config                     # optional dataset-specific config
├── sample_metadata.csv                 # generated by step 1
└── sample_metadata_gcp_YYYY_MM_DD.csv  # generated by step 2
```

## Step 1: Generate Per-Sample Metadata

This step queries the IGVF data portal to create a sample metadata CSV.

### Requirements

- Analysis Set accession from IGVF portal (e.g., `IGVFDS4761PYUO`)
- Seqspec YAML files for each modality

### Configuration

Edit `bin/1_CRISPR_pipeline/1_generate_per_sample_metadata.sh`:

```bash
# Base directory (change this for your environment)
BASE_DIR=/path/to/tf_perturb_seq

# Dataset name (should match folder name)
DATASET_NAME=<YOUR_DATASET_NAME>

# Analysis set ID from IGVF portal
ACCESSION=<YOUR_ACCESSION>
```

### Run

```bash
cd datasets/<DATASET_NAME>
./bin/1_CRISPR_pipeline/1_generate_per_sample_metadata.sh
```

### Output

- `sample_metadata.csv` - Contains columns:
  - `R1_path`, `R2_path` - IGVF accessions for FASTQ files
  - `file_modality` - `scRNA`, `gRNA`, or `hash`
  - `measurement_sets` - Associated measurement set accession
  - `sequencing_run`, `lane` - Sequencing metadata
  - `seqspec` - Path to seqspec file
  - `barcode_onlist` - Cell barcode whitelist
  - `guide_design` - Guide RNA sequences file
  - `barcode_hashtag_map` - HTO mapping (if applicable)

## Step 2: Upload to GCP

This step transfers files from IGVF S3 storage and local paths to Google Cloud Storage.

### Configuration

Edit `bin/1_CRISPR_pipeline/2_upload_to_gcp.sh`:

```bash
# Base directory
BASE_DIR=/path/to/tf_perturb_seq

# Dataset name
DATASET_NAME=<YOUR_DATASET_NAME>

# GCP project
PROJECT=igvf-pertub-seq-pipeline

# GCS bucket
GCS_BUCKET=igvf-pertub-seq-pipeline-data
```

### Run

```bash
# Dry run first to verify
DRY_RUN=true ./bin/1_CRISPR_pipeline/2_upload_to_gcp.sh

# Actual upload
./bin/1_CRISPR_pipeline/2_upload_to_gcp.sh
```

### Output

- `sample_metadata_gcp_YYYY_MM_DD.csv` - Same as input but with GCS paths

### Verify Upload

```bash
# Check that files exist in GCS
gsutil ls gs://igvf-pertub-seq-pipeline-data/<DATASET_NAME>/
```

## Step 3: Run CRISPR Pipeline

This step executes the Nextflow CRISPR pipeline on Google Cloud Batch.

### Configuration

Edit `bin/1_CRISPR_pipeline/3_run_CRISPR_pipeline.sh`:

```bash
# Dataset name
DATASET_NAME=<YOUR_DATASET_NAME>

# Base directory
BASE_DIR=/path/to/tf_perturb_seq/datasets/${DATASET_NAME}

# Sample metadata (use the GCP version from step 2)
SAMPLE_METADATA=$BASE_DIR/sample_metadata_gcp_YYYY_MM_DD.csv

# CRISPR Pipeline path
PIPELINE_PATH=/path/to/CRISPR_Pipeline

# Output directory on GCS
OUTDIR=gs://igvf-pertub-seq-pipeline-data/${DATASET_NAME}/YYYY_MM_DD/outs
```

### Run

```bash
# Run in foreground (blocks terminal)
./bin/1_CRISPR_pipeline/3_run_CRISPR_pipeline.sh

# Run in background
RUN_IN_BACKGROUND=true ./bin/1_CRISPR_pipeline/3_run_CRISPR_pipeline.sh
```

### Monitor Progress

```bash
# If running in background, check the log file
tail -f logs/<DATASET_NAME>_crispr_pipeline_*.log

# Check Nextflow Tower (if configured)
# https://tower.nf
```

### Output

The pipeline outputs to `$OUTDIR` on GCS:
- Gene expression matrices
- Guide assignment matrices
- QC reports
- MuData objects

## Seqspec Files

Seqspec YAML files define the structure of sequencing reads. Each modality needs its own seqspec:

### RNA Seqspec (`rna_seqspec.yml`)

Defines 10x Genomics scRNA-seq read structure (cell barcode, UMI, cDNA).

### Guide Seqspec (`guide_seqspec.yml`)

Defines guide RNA capture read structure.

### Hash Seqspec (`hash_seqspec.yml`)

Defines cell hashing barcode read structure (only needed if using HTOs).

See example seqspecs in:
```
datasets/Hon_WTC11-benchmark_TF-Perturb-seq/bin/1_CRISPR_pipeline/seqspec/yaml_files/
```

## Troubleshooting

### "Cannot invoke method toLowerCase() on null object"

The sample metadata CSV has incorrect format. Ensure:
- File is comma-separated (not TSV)
- `file_modality` column contains `scRNA`, `gRNA`, or `hash` (not full names)

### IGVF API 403 Forbidden

Set your IGVF credentials:
```bash
export IGVF_API_KEY="your-key"
export IGVF_SECRET_KEY="your-secret"
```

### GCS paths don't exist

Run the validation script:
```bash
python scripts/validate_gcp_paths.py --input sample_metadata_gcp_*.csv
```

### Nextflow requires Java 17+

Install Java 17 or higher:
```bash
# macOS with Homebrew
brew install openjdk@17

# Or download from https://adoptium.net/
```

## Related Issues

- [Issue #4: Harmonized pipeline config](https://github.com/adamklie/tf_perturb_seq/issues/4)
- [Issue #6: Run CRISPR FG pipeline on all datasets](https://github.com/adamklie/tf_perturb_seq/issues/6)
