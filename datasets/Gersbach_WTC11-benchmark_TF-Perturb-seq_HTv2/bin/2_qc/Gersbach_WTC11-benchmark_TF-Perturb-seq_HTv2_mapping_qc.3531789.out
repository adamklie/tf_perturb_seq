=============================================
 Running TF Perturb-seq QC Pipeline
 SAMPLE: Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2
 OUTDIR: /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06
=============================================
---- [1/3] Running mapping_qc.py ----
2026-01-06 13:03:49,576 - __main__ - INFO - Loading MuData from /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/1_CRISPR_pipeline/2026_01_06/inference_mudata.h5mu
/cellar/users/aklie/opt/miniconda3/envs/scverse-lite-py311/lib/python3.11/site-packages/mudata/_core/mudata.py:1598: FutureWarning: From 0.4 .update() will not pull obs/var columns from individual modalities by default anymore. Set mudata.set_options(pull_on_update=False) to adopt the new behaviour, which will become the default. Use new pull_obs/pull_var and push_obs/push_var methods for more flexibility.
  self._update_attr("var", axis=0, join_common=join_common)
/cellar/users/aklie/opt/miniconda3/envs/scverse-lite-py311/lib/python3.11/site-packages/mudata/_core/mudata.py:1461: FutureWarning: From 0.4 .update() will not pull obs/var columns from individual modalities by default anymore. Set mudata.set_options(pull_on_update=False) to adopt the new behaviour, which will become the default. Use new pull_obs/pull_var and push_obs/push_var methods for more flexibility.
  self._update_attr("obs", axis=1, join_common=join_common)
2026-01-06 13:04:03,864 - utils - INFO - MuData: 33778 cells total, modalities=['gene', 'guide']
2026-01-06 13:04:03,864 - utils - INFO -   Modality 'gene': 33778 cells, 13425 features
2026-01-06 13:04:03,864 - utils - INFO -   Modality 'guide': 33778 cells, 416 features
2026-01-06 13:04:03,864 - utils - INFO - Adding sample name 'Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2' to barcodes
2026-01-06 13:04:03,864 - utils - INFO -   Example before: AATCGGTTCAGCTCGG_0
2026-01-06 13:04:03,865 - utils - INFO -   Example after:  Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2#AATCGGTTCAGCTCGG_0
2026-01-06 13:04:03,868 - utils - INFO - Guide modality: computed n_guides_per_cell (obs) and n_cells_per_guide (var) from layer 'guide_assignment'
2026-01-06 13:04:03,869 - __main__ - INFO - Running pre-filter QC
2026-01-06 13:04:04,268 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/pre_filter_gene_knee_plot.png
2026-01-06 13:04:04,268 - utils - INFO - Gene knee plot (UMIs per cell) - min count: 1206, max count: 177646
2026-01-06 13:04:05,081 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/pre_filter_gene_qc_histograms_by_batch.png
2026-01-06 13:04:05,283 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/pre_filter_cells_per_batch.png
2026-01-06 13:04:05,608 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/pre_filter_guide_knee_plot.png
2026-01-06 13:04:05,609 - utils - INFO - Guide knee plot (guide UMIs per cell) - min count: 1, max count: 22663
2026-01-06 13:04:06,363 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/pre_filter_guide_qc.png
2026-01-06 13:04:06,798 - __main__ - INFO - Applying joint filters (gene + guide)
2026-01-06 13:04:06,799 - utils - INFO - Cells before filtering: 33778
2026-01-06 13:04:06,799 - utils - INFO - Cells after filtering:  33778
2026-01-06 13:04:07,208 - __main__ - INFO - Running post-filter QC
2026-01-06 13:04:07,590 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/post_filter_gene_knee_plot.png
2026-01-06 13:04:07,590 - utils - INFO - Gene knee plot (UMIs per cell, filtered) - min count: 1206, max count: 177646
2026-01-06 13:04:08,398 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/post_filter_gene_qc_histograms_by_batch.png
2026-01-06 13:04:08,600 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/post_filter_cells_per_batch.png
2026-01-06 13:04:08,933 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/post_filter_guide_knee_plot.png
2026-01-06 13:04:08,933 - utils - INFO - Guide knee plot (guide UMIs per cell, filtered) - min count: 1, max count: 22663
2026-01-06 13:04:09,751 - utils - INFO - Saved /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/post_filter_guide_qc.png
2026-01-06 13:04:10,193 - __main__ - INFO - Wrote combined metrics TSV to: /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/qc_metrics.tsv
2026-01-06 13:04:10,193 - __main__ - INFO - Writing filtered gene AnnData to /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/gene.filtered.h5ad
2026-01-06 13:04:12,275 - __main__ - INFO - Writing filtered guide AnnData to /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/guide.filtered.h5ad
2026-01-06 13:04:12,359 - __main__ - INFO - QC script finished.
QC complete → /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/mapping_qc/gene.filtered.h5ad

---- [2/3] Running preprocess.py ----
Preprocessing complete → /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/preprocess/gene.preprocessed.h5ad

---- [3/3] Running cluster.py ----
Clustering complete → /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06/clustering/gene.clustered.h5ad

=============================================
  Pipeline finished for sample: Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2
  Outputs written to: /cellar/users/aklie/data/datasets/tf_perturb_seq/datasets/Gersbach_WTC11-benchmark_TF-Perturb-seq_HTv2/results/2_qc/2026_01_06
=============================================
